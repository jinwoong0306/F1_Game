# 멀티플레이 진행상황

## 최근 수정 내용 (2025-12-04)

### 1. 트랙 선택 검증 완료
- 싱글플레이와 멀티플레이 모두 동일한 트랙 매핑 확인
  - Track 1: NEON CITY → f1_racing_map.tmx
  - Track 2: JAPAN CIRCUIT → japan.tmx
  - Track 3: AMERICA GP → america.tmx
- 파일 위치:
  - `core/src/main/java/com/mygame/f1/screens/SinglePlayScreen.java:303-308`
  - `core/src/main/java/com/mygame/f1/screens/MultiplayerPlaceholderScreen.java:782-790`

### 2. 미니맵 플레이어 색상 구분 기능 추가
- 각 플레이어가 미니맵에서 고유한 색상으로 표시
- 색상 팔레트:
  - Player 1: 밝은 파란색 (0.2, 0.6, 1.0)
  - Player 2: 밝은 초록색 (0.2, 1.0, 0.4)
  - Player 3: 노란색 (1.0, 0.8, 0.2)
  - Player 4: 핑크색 (1.0, 0.4, 0.9)
- 구현 방식: `playerId % 4`를 사용한 안정적인 색상 할당
- 파일: `core/src/main/java/com/mygame/f1/GameScreen.java:1304-1316`
- 커밋: `2c6d37f`, `7271fc3`

### 3. 고스트 플레이어 버그 수정
**문제**: 비정상 연결 종료 시 플레이어가 게임에 남아있는 현상

**원인**:
- GameServer의 `connected()` 콜백에 keep-alive 및 timeout 설정 누락
- 네트워크 장애나 전원 차단 시 서버가 연결 종료를 감지하지 못함

**해결책**:
```java
connection.setKeepAliveTCP(8000);   // 8초마다 하트비트 전송
connection.setTimeout(20000);        // 20초 동안 응답 없으면 연결 종료
```

**기술 세부사항**:
- Keep-alive 간격: 8초 (업계 표준)
- Timeout: 20초 (keep-alive의 2.5배)
- 20초 내에 죽은 연결 감지 및 자동 정리

**파일**: `server/src/main/java/com/mygame/f1/server/GameServer.java:51-57`
**커밋**: `83634ba`

### 4. TMX 맵 파일 업데이트
- `assets/f1_racing_map.tmx` (472줄 변경)
- `assets/japan.tmx` (472줄 변경)
- `assets/america.tmx` (537줄 변경)
- 체크포인트 위치, 오브젝트 레이아웃, 트랙 최적화

### 5. 서버 배포 스크립트 추가
- `deploy_server.sh`: 연구실 서버(203.234.62.35)로 배포
- `run_multiplayer_client.bat`: 클라이언트 IP 203.234.62.51로 업데이트

## 현재 구현된 멀티플레이 기능

### 네트워크 아키텍처
- KryoNet 기반 TCP/UDP 통신
- Server-authoritative 아키텍처
- 클라이언트 보간 계수: 20 (0.05f)
- Keep-alive: 8초, Timeout: 20초

### 로비 시스템
- 방 생성/참가/나가기
- 최대 4명 플레이어
- Ready 상태 관리
- 트랙/차량 선택 동기화
- 실시간 채팅

### 레이스 시스템
- 카운트다운 후 시작
- 실시간 위치 동기화 (UDP)
- 랩 타임 추적
- 1등 완주 시 10초 카운트다운
- 최종 순위 및 FAIL 처리

### 결과 화면
- 순위별 색상 표시 (1위 금색, 2위 은색, 3위 동메달색)
- 총 시간 및 베스트 랩 타임 표시
- DNF(Did Not Finish) 플레이어 구분
- Return to Lobby / Exit 버튼

### 클라이언트 기능
- 미니맵 플레이어 색상 구분
- 원격 플레이어 위치 보간
- 로컬/원격 충돌 처리

## 다음 단계
- [ ] singleplay-polish 브랜치의 UI/게임 로직 개선사항 병합
- [ ] 멀티플레이 기능 유지하면서 싱글플레이 개선사항 적용
- [ ] 병합 후 테스트 및 검증
